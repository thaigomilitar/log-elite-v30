<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Log√≠stica Vision V39.1</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root { --accent: #00ff41; --bg: #050505; --card: #121212; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }

        /* MIRA DIN√ÇMICA */
        #mira {
            position: absolute; border: 2px solid var(--accent);
            border-radius: 12px; pointer-events: none; z-index: 100;
            display: none; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 0 20px var(--accent);
        }

        video { width: 100%; height: 100vh; object-fit: cover; }
        
        /* BOT√ÉO FLUTUANTE LOGO */
        .fab {
            position: fixed; bottom: 30px; right: 30px;
            width: 70px; height: 70px;
            background: url('logo.jpeg') center/cover;
            border-radius: 50%; border: 3px solid var(--accent); z-index: 200;
            box-shadow: 0 0 15px rgba(0,255,65,0.4);
        }

        #status { position: fixed; top: 20px; width: 100%; text-align: center; color: var(--accent); font-weight: bold; z-index: 50; text-shadow: 2px 2px 4px #000; }

        /* TELA DE RELAT√ìRIO */
        .screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); display: none; flex-direction: column; padding: 25px;
            box-sizing: border-box; z-index: 300;
        }
        .item { background: var(--card); padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid var(--accent); }
    </style>
</head>
<body>

    <div id="status">INICIALIZANDO GEMINI 2.0 LITE...</div>
    <video id="video" autoplay playsinline></video>
    <div id="mira"></div>

    <div class="fab" onclick="abrirGestao()"></div>

    <div id="gestao" class="screen">
        <h2 style="color: var(--accent);">üì¶ Relat√≥rio de Campo</h2>
        <div id="lista-entregas" style="flex: 1; overflow-y: auto;"></div>
        <button onclick="gerarPDF()" style="width: 100%; padding: 20px; background: var(--accent); border: none; border-radius: 12px; font-weight: bold; margin-bottom: 10px;">COMPARTILHAR PDF (WHATSAPP)</button>
        <button onclick="fecharGestao()" style="width: 100%; padding: 15px; background: #222; border: none; color: white; border-radius: 12px;">VOLTAR AO SCANNER</button>
    </div>

    <script>
        const API_KEY = "AIzaSyCoIrsaFgIMUAvl2Ps7_G2cT9zCh5zhsus";
        let entregas = [];
        let contagem = {};

        // 1. MOTOR DE VOZ E √ÅUDIO
        function alertar(texto) {
            const msg = new SpeechSynthesisUtterance(texto);
            msg.lang = 'pt-BR';
            window.speechSynthesis.speak(msg);
        }

        // 2. INTEGRA√á√ÉO GEMINI 2.0 FLASH LITE
        async function capturarEtiqueta() {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const base64Image = canvas.toDataURL('image/jpeg').split(',')[1];

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-lite-preview-02-05:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: "Analise esta etiqueta. Extraia estritamente o NOME do destinat√°rio e o ENDERE√áO. Se houver mais de um pacote para o mesmo nome, ignore. Responda em JSON: {nome: '', endereco: ''}" }, { inline_data: { mime_type: "image/jpeg", data: base64Image } }] }]
                    })
                });
                
                const data = await response.json();
                const resultado = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g, ""));
                
                processarResultado(resultado.nome, resultado.endereco);
            } catch (e) { console.log("Erro na leitura"); }
        }

        function processarResultado(nome, endereco) {
            if (!nome || !endereco) return;
            
            const id = nome + endereco;
            if (contagem[id]) {
                contagem[id]++;
                alertar(`Aten√ß√£o Thiago, √© o ${contagem[id]}¬∫ pacote para ${nome}`);
            } else {
                contagem[id] = 1;
                entregas.push({ nome, endereco, hora: new Date().toLocaleTimeString() });
                document.getElementById('status').innerText = "‚úÖ CAPTURADO: " + nome;
                ativarMira();
                // Bip de sucesso
            }
        }

        function ativarMira() {
            const mira = document.getElementById('mira');
            mira.style.display = 'block';
            mira.style.top = '45%'; mira.style.left = '10%'; mira.style.width = '80%'; mira.style.height = '10%';
            setTimeout(() => { mira.style.display = 'none'; document.getElementById('status').innerText = "AGUARDANDO PR√ìXIMO..."; }, 2000);
        }

        // 3. PDF E GEST√ÉO
        function gerarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("LOG√çSTICA ELITE - RELAT√ìRIO DE ENTREGAS", 20, 20);
            entregas.forEach((e, i) => {
                doc.text(`${i+1}. ${e.nome} - ${e.endereco} [${e.hora}]`, 20, 40 + (i * 10));
            });
            doc.save("entregas_dia.pdf");
        }

        function abrirGestao() { document.getElementById('gestao').style.display = 'flex'; renderLista(); }
        function fecharGestao() { document.getElementById('gestao').style.display = 'none'; }
        function renderLista() {
            document.getElementById('lista-entregas').innerHTML = entregas.map(e => `
                <div class="item">
                    <b>üë§ ${e.nome}</b><br>
                    <small>üìç ${e.endereco}</small>
                </div>
            `).join('');
        }

        // Inicializa√ß√£o
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(s => { 
                document.getElementById('video').srcObject = s;
                setInterval(capturarEtiqueta, 4000); // Tira uma foto a cada 4s
            });
    </script>
</body>
</html>
