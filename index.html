<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Vision 43.2</title>
    <style>
        :root { --accent: #00ff41; }
        body { margin: 0; background: #000; color: #fff; font-family: sans-serif; text-align: center; }
        #status { position: fixed; top: 0; width: 100%; padding: 20px; background: rgba(0,0,0,0.9); color: var(--accent); font-weight: bold; z-index: 100; border-bottom: 2px solid #333; }
        video { width: 100%; height: 100vh; object-fit: cover; }
        #setup { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .box { border: 2px solid var(--accent); padding: 20px; border-radius: 15px; width: 100%; max-width: 320px; background: #111; }
        input { width: 100%; padding: 15px; margin: 15px 0; border-radius: 8px; border: 1px solid #444; background: #000; color: var(--accent); box-sizing: border-box; }
        button { width: 100%; padding: 15px; border-radius: 8px; border: none; background: var(--accent); font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div id="setup" style="display: none;">
    <div class="box">
        <h2 style="color: var(--accent)">SISTEMA ATIVO</h2>
        <p>Cole a Chave do Google:</p>
        <input type="text" id="apiKey" placeholder="AIzaSy...">
        <button onclick="save()">CONECTAR IA</button>
    </div>
</div>

<div id="status">INICIANDO...</div>
<video id="video" autoplay playsinline></video>

<script>
    // Nome de storage novo para forçar limpeza de lixo anterior
    const STORAGE = 'gemini_final_v432';
    let KEY = localStorage.getItem(STORAGE);
    let busy = false;

    window.onload = () => {
        if (!KEY) document.getElementById('setup').style.display = 'flex';
        else start();
    };

    function save() {
        const val = document.getElementById('apiKey').value.trim(); // Trim remove espaços extras
        if (val.length > 20) {
            localStorage.setItem(STORAGE, val);
            location.reload();
        } else {
            alert("Chave muito curta!");
        }
    }

    async function start() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            document.getElementById('video').srcObject = stream;
            document.getElementById('status').innerText = "FLASH ONLINE";
            setInterval(scan, 5000);
        } catch (e) {
            document.getElementById('status').innerText = "ERRO: LIGUE A CÂMERA";
        }
    }

    async function scan() {
        if (busy || !KEY) return;
        busy = true;
        document.getElementById('status').innerText = "LENDO...";

        try {
            const v = document.getElementById('video');
            const canvas = document.createElement('canvas');
            canvas.width = 800; canvas.height = 600;
            canvas.getContext('2d').drawImage(v, 0, 0, 800, 600);
            const base64 = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [
                        { text: "Extraia Nome e Endereço em JSON: {nome:'', endereco:''}" },
                        { inline_data: { mime_type: "image/jpeg", data: base64 } }
                    ]}]
                })
            });

            const data = await response.json();

            if (data.error) {
                // Se a chave for inválida, ele vai mostrar o erro do Google aqui
                document.getElementById('status').innerText = "GOOGLE DIZ: " + data.error.message;
            } else {
                const res = JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim());
                if (res.nome) {
                    document.getElementById('status').innerText = "✅ " + res.nome.toUpperCase();
                    window.speechSynthesis.speak(new SpeechSynthesisUtterance(res.nome));
                } else {
                    document.getElementById('status').innerText = "BUSCANDO...";
                }
            }
        } catch (e) {
            document.getElementById('status').innerText = "TENTANDO NOVAMENTE...";
        } finally {
            busy = false;
        }
    }
</script>
</body>
</html>
